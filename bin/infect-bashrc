#!/bin/bash

NOMAD_BASE=~/.nomad/bash/enabled/
NEW_BASHRC=~/.nomad_bashrc

echo_and_eval() {
    input=`cat`
    echo "$input"
    eval "$input"
}

# Clear out old dynamic portion of bashrc
unique=uijooQu2
# p - print lines; q - quit when unique pattern is found
sed -n "/$unique/q;p" ~/.bashrc > $NEW_BASHRC
echo "# DO NOT EDIT BELOW -- Dynamically generated with nomad -- $unique" >> $NEW_BASHRC
echo >> $NEW_BASHRC

# find - get bash source files
# awk - put the filename at the front of the line
# sort - duh
# cut - get rid of the filename at the front of the line
files=$(find -L $NOMAD_BASE -type f ! -iname ".*" | \
    awk -v FS=/ -v OFS=/ '{print $NF,$0}' | \
    sort | \
    cut -f2- -d/)

# source the bash files by the order in which they are named
for file in $files; do
    output=$(source $file)
    if [ "$(echo $output | wc -c)" -gt 1 ]; then
        echo '####' >> $NEW_BASHRC
        echo \## $(echo $file) >> $NEW_BASHRC
        echo '####' >> $NEW_BASHRC
        echo "$output" >> $NEW_BASHRC
        echo >> $NEW_BASHRC
    fi
done

# Allow echo_and_eval to be used for sourcing nomad scripts
echo '####' >> $NEW_BASHRC
echo \## Allow nomad bash scripts to be \`source\`ed >> $NEW_BASHRC
echo '####' >> $NEW_BASHRC
declare -f echo_and_eval >> $NEW_BASHRC

mv ~/.bashrc ~/.bashrc.old
mv $NEW_BASHRC ~/.bashrc
